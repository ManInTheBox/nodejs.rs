#!/usr/bin/env node

/**
 * EmailCommand
 */
 
var Email = require('../models/email'),
  cycleTime = 1000,
  conditions = {
    sent: false,
    sendingCounter: {
      $lt: 5
    }
  };

var i = 0;

// TODO: error handling (now we just skip errors b/c that will stop command)
var mailer = function () {
  Email.find(conditions).asc('priority').run(function (err, emails) {
    // if (err) throw err;
    var len = emails.length;
    if (len) {
      emails.forEach(function (email) {
        email.doSend(function (err) {
          console.log('poslao na:', email.to)
          // if (err) throw err;
          if (--len === 0) { // next iteration
            console.log('next queue, cycle:', ++i);
            setTimeout(mailer, cycleTime);
          }
        });
      });
    } else {
      console.log('prazan queue, cycle:', ++i);
      setTimeout(mailer, cycleTime); //next iteration
    }
  });
};

// start command
mailer();